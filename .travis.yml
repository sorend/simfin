language: python

python:
  - "3.8"

notifications:
  email: false

before_install:
  - travis_retry wget http://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh
  - chmod +x miniconda.sh
  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH=/home/travis/miniconda/bin:$PATH
  - conda update --yes conda

install:
  - conda create --yes -n test python=$TRAVIS_PYTHON_VERSION
  - source activate test
  - conda install --yes numpy pandas requests pyarrow
  - pip install pytest nbval pytest-cov codecov
  - python setup.py install

script:
  - pytest --nbval-lax -v tests/test_bulk_data.ipynb

after_success:
  - codecov

stages:
  - test
  - deploy

jobs:
  include:
    - stage: deploy
      deploy:
        - provider: pypi
          distributions: sdist bdist_wheel
          server: https://upload.pypi.org/legacy/
          on:
            branch: master
            tags: true
        - provider: pypi
          distributions: sdist bdist_wheel
          server: https://test.pypi.org/legacy/
          on:
            all_branches: true
